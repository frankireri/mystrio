# Database Schema for Mystrio API

This document outlines the structure of the MySQL/MariaDB database used by the Mystrio backend API.

---

## Table: `users`

Stores user authentication and profile information.

```sql
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(255) NOT NULL,
  email VARCHAR(255) NOT NULL UNIQUE,
  password VARCHAR(255) NOT NULL, -- Hashed password using bcrypt
  chosen_question_text TEXT, -- User's chosen default question text
  chosen_question_style_id VARCHAR(255), -- ID for the chosen question card style
  profile_image_path VARCHAR(255), -- Path to the user's profile image
  premium_until TIMESTAMP NULL DEFAULT NULL, -- Timestamp when premium access expires
  is_admin BOOLEAN NOT NULL DEFAULT FALSE, -- New: Flag to identify admin users
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Columns:**
*   `id` (INT, PRIMARY KEY, AUTO_INCREMENT): Unique identifier for the user.
*   `username` (VARCHAR(255), NOT NULL): User's chosen display name.
*   `email` (VARCHAR(255), NOT NULL, UNIQUE): User's email address, used for login. Must be unique.
*   `password` (VARCHAR(255), NOT NULL): Hashed password.
*   `chosen_question_text` (TEXT): The default question text chosen by the user. Can be NULL.
*   `chosen_question_style_id` (VARCHAR(255)): Identifier for the style of the user's question card. Can be NULL.
*   `profile_image_path` (VARCHAR(255)): URL or path to the user's profile image. Can be NULL.
*   `premium_until` (TIMESTAMP, NULL, DEFAULT NULL): Timestamp indicating when premium access expires. NULL if not premium.
*   `is_admin` (BOOLEAN, NOT NULL, DEFAULT FALSE): Set to `TRUE` (or `1`) for admin users.
*   `created_at` (TIMESTAMP): Timestamp when the user account was created.
*   `updated_at` (TIMESTAMP): Timestamp when the user account was last updated.

---

## Table: `questions`

Stores questions asked by users and their corresponding answers.

```sql
CREATE TABLE questions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NULL, -- NEW: user_id can now be NULL for anonymous questions
  recipient_user_id INT NOT NULL, -- NEW: The ID of the user who receives the question
  question_text TEXT NOT NULL,
  answer_text TEXT, -- Nullable, as questions might be unanswered
  is_from_ai BOOLEAN DEFAULT FALSE,
  hints TEXT, -- Stores additional metadata as a JSON string (TEXT type for broader compatibility)
  sender_ip_address VARCHAR(45), -- NEW: Store sender's IP for moderation (IPv4 or IPv6)
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL, -- NEW: If sender is deleted, set to NULL
  FOREIGN KEY (recipient_user_id) REFERENCES users(id) ON DELETE CASCADE -- NEW: If recipient is deleted, delete question
);
```

**Columns:**
*   `id` (INT, PRIMARY KEY, AUTO_INCREMENT): Unique identifier for the question.
*   `user_id` (INT, NULL): Foreign key referencing the `id` in the `users` table. **NULL for anonymous questions.** `ON DELETE SET NULL` means if the sender is deleted, this field becomes NULL.
*   `recipient_user_id` (INT, NOT NULL): **NEW:** Foreign key referencing the `id` of the user who is receiving this question. `ON DELETE CASCADE` means if the recipient is deleted, their questions are also deleted.
*   `question_text` (TEXT, NOT NULL): The content of the question.
*   `answer_text` (TEXT): The answer to the question. Can be NULL.
*   `is_from_ai` (BOOLEAN, DEFAULT FALSE): Indicates if the question was generated by AI.
*   `hints` (TEXT): Stores additional data (e.g., context, metadata) as a JSON string. Stored as TEXT for compatibility.
*   `sender_ip_address` (VARCHAR(45)): **NEW:** Stores the IP address of the sender for moderation purposes.
*   `created_at` (TIMESTAMP): Timestamp when the question was created.
*   `updated_at` (TIMESTAMP): Timestamp when the question was last updated.

---

## Table: `quizzes`

Stores user-created quizzes.

```sql
CREATE TABLE quizzes (
  id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**Columns:**
*   `id` (INT, PRIMARY KEY, AUTO_INCREMENT): Unique identifier for the quiz.
*   `user_id` (INT, NOT NULL): Foreign key referencing the `id` in the `users` table. `ON DELETE CASCADE` means if the user is deleted, their quizzes are also deleted.
*   `title` (VARCHAR(255), NOT NULL): The title of the quiz.
*   `description` (TEXT): A description of the quiz.
*   `created_at` (TIMESTAMP): Timestamp when the quiz was created.
*   `updated_at` (TIMESTAMP): Timestamp when the quiz was last updated.
